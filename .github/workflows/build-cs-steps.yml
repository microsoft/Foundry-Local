name: Build C# SDK

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      useWinML:
        required: false
        type: boolean
        default: false
      useNightly:
        required: false
        type: boolean
        default: true
      buildConfiguration:
        required: false
        type: string
        default: 'Debug' # or 'Release'

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest
    env:
      buildConfiguration: 'Debug'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: true

      # adapted from https://github.com/actions/setup-dotnet?tab=readme-ov-file#azure-artifacts
      # saves auth credentials to ../nuget.config
      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'
          source-url: https://pkgs.dev.azure.com/microsoft/windows.ai.toolkit/_packaging/Neutron/nuget/v3/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.AZURE_DEVOPS_PAT }}

      - name: Add ORT Feed (Nightly)
        if: ${{ inputs.useNightly }}
        run: dotnet nuget add source "https://pkgs.dev.azure.com/aiinfra/PublicPackages/_packaging/ORT/nuget/v3/index.json" -n ORT --configfile ../nuget.config

      - name: Resolve Nightly Version
        if: ${{ inputs.useNightly }}
        shell: pwsh
        run: |
          $UseWinML = "${{ inputs.useWinML }}"
          $PackageId = if ($UseWinML -eq 'true') { "Microsoft.AI.Foundry.Local.Core.WinML" } else { "Microsoft.AI.Foundry.Local.Core" }
          $FeedUrl = "https://pkgs.dev.azure.com/aiinfra/PublicPackages/_packaging/ORT/nuget/v3/index.json"
          
          Write-Host "Resolving latest nightly version for $PackageId from $FeedUrl..."
          
          try {
              $serviceIndex = Invoke-RestMethod -Uri $FeedUrl
              $baseAddressRes = $serviceIndex.resources | Where-Object { $_.'@type' -like "PackageBaseAddress/3.0.0*" } | Select-Object -First 1
              $baseAddress = $baseAddressRes.'@id'
              $versionsUrl = "${baseAddress}$($PackageId.ToLower())/index.json"
              
              $versionData = Invoke-RestMethod -Uri $versionsUrl
              $versions = $versionData.versions
              if (-not $versions) { throw "No versions found" }
              
              # Sort descending to prioritize latest date-based versions
              $latestVersion = $versions | Sort-Object -Descending | Select-Object -First 1
              Write-Host "Found latest version: $latestVersion"
              
              # Set env var for subsequent steps
              "FOUNDRY_CORE_VERSION=$latestVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
          } catch {
              Write-Error "Failed to resolve version: $_"
              exit 1
          }

      - name: Restore dependencies
        run: |
          dotnet restore sdk_v2\cs\src\Microsoft.AI.Foundry.Local.csproj /p:UseWinML=${{ inputs.useWinML }} /p:FoundryLocalCoreVersion=${{ env.FOUNDRY_CORE_VERSION }} --configfile ../nuget.config

      - name: Build solution
        run: |
          dotnet build sdk_v2\cs\src\Microsoft.AI.Foundry.Local.csproj --configfile ../nuget.config --no-restore --configuration ${{ inputs.buildConfiguration }} /p:UseWinML=${{ inputs.useWinML }} /p:FoundryLocalCoreVersion=${{ env.FOUNDRY_CORE_VERSION }}

      # need to use direct git commands to clone from Azure DevOps instead of actions/checkout
      - name: Checkout test-data-shared from Azure DevOps
        shell: pwsh
        working-directory: ${{ github.workspace }}\..
        run: |
          $pat = "${{ secrets.AZURE_DEVOPS_PAT }}"
          $encodedPat = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(":$pat"))
          
          # Configure git to use the PAT
          git config --global http.https://dev.azure.com.extraheader "AUTHORIZATION: Basic $encodedPat"
          
          # Clone with LFS to parent directory
          git lfs install
          git clone --depth 1 https://dev.azure.com/microsoft/windows.ai.toolkit/_git/test-data-shared test-data-shared
          
          Write-Host "Clone completed successfully to ${{ github.workspace }}\..\test-data-shared"

      - name: Checkout specific commit in test-data-shared
        shell: pwsh
        working-directory: ${{ github.workspace }}\..\test-data-shared
        run: |
          Write-Host "Current directory: $(Get-Location)"
          git checkout 231f820fe285145b7ea4a449b112c1228ce66a41
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Git checkout failed."
            exit 1
          }
          Write-Host "`nDirectory contents:"
          Get-ChildItem -Recurse -Depth 2 | ForEach-Object { Write-Host "  $($_.FullName)" }

      - name: Run Foundry Local Core tests
        run: |
          dotnet test sdk_v2\cs\test\FoundryLocal.Tests\Microsoft.AI.Foundry.Local.Tests.csproj --verbosity normal /p:UseWinML=${{ inputs.useWinML }} /p:FoundryLocalCoreVersion=${{ env.FOUNDRY_CORE_VERSION }}

      - name: Pack NuGet package
        shell: pwsh
        run: |
          $projectPath = "sdk_v2\cs\src\Microsoft.AI.Foundry.Local.csproj"
          $outputDir = "sdk_v2\cs\bin"
          $version = "${{ inputs.version }}"
          $config = "${{ inputs.buildConfiguration }}"
          $useWinML = "${{ inputs.useWinML }}"
          $coreVersion = "${{ env.FOUNDRY_CORE_VERSION }}"
          
          Write-Host "Packing project: $projectPath"
          Write-Host "Output directory: $outputDir"
          Write-Host "Version: $version"
          Write-Host "Configuration: $config"
          Write-Host "UseWinML: $useWinML"
          Write-Host "FoundryLocalCoreVersion: $coreVersion"
          
          & dotnet pack $projectPath --no-build --configuration $config --output $outputDir /p:PackageVersion=$version /p:UseWinML=$useWinML /p:FoundryLocalCoreVersion=$coreVersion /p:IncludeSymbols=true /p:SymbolPackageFormat=snupkg --verbosity normal
          
          if ($LASTEXITCODE -ne 0) {
              Write-Error "dotnet pack failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
          }
          
          Write-Host "Pack completed successfully"
          Write-Host "Generated packages:"
          Get-ChildItem -Path $outputDir -Filter "*.nupkg" | ForEach-Object { Write-Host "  $($_.Name)" }
          Get-ChildItem -Path $outputDir -Filter "*.snupkg" | ForEach-Object { Write-Host "  $($_.Name)" }

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: cs-sdk
          path: |
            sdk_v2\cs\bin\*.nupkg
            sdk_v2\cs\bin\*.snupkg
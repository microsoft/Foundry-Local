name: Build JS SDK

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      useWinML:
        required: false
        type: boolean
        default: false
      platform:
        required: false
        type: string
        default: 'windows' # or 'macos' or 'ubuntu'

permissions:
  contents: read

jobs:
  build:
    # https://github.com/actions/runner-images?tab=readme-ov-file#available-images
    runs-on: ${{ inputs.platform }}-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      # needed to download Foundry Local Core from Azure Artifacts
      - name: Setup .NET SDK for NuGet authentication
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.AZURE_DEVOPS_PAT }}

      # Fixes 'System.Security.Cryptography.CryptographicException' on Linux CI
      - name: Configure Linux SSL (Lower TLS Version)
        if: ${{ inputs.platform == 'ubuntu' }}
        run: |          
          # 1. Diagnostic: Check TLS negotiation
          echo "Testing TLS to ai.azure.com..."
          echo "Q" | openssl s_client -connect ai.azure.com:443 -brief || echo "OpenSSL connection failed"

          # 2. Fix: Lower MinProtocol to TLSv1.0
          OPENSSL_CONF=$(openssl version -d | cut -d '"' -f 2)/openssl.cnf
          echo "Modifying MinProtocol in $OPENSSL_CONF"
          
          # Replace MinProtocol = TLSv1.2 (or similar) with TLSv1.0
          sudo sed -i 's/MinProtocol = TLSv1\.[0-9]/MinProtocol = TLSv1.0/g' "$OPENSSL_CONF"
          
          # Log the change
          grep "MinProtocol" "$OPENSSL_CONF" || echo "MinProtocol setting not found in config"

      - name: Format version for JS
        shell: pwsh
        run: |
          # Release: 0.9.0.41 -> 0.9.0-41
          $version = "${{ inputs.version }}"
          $versionParts = $version -split '\.'
          $baseVersion = ($versionParts[0..2]) -join '.'
          $buildNumber = $versionParts[3]
          $version = "$baseVersion-$buildNumber"
          Write-Host "Modified version for JS: $version"
          Write-Host "ProjectVersion=$version" >> $env:GITHUB_ENV

      # need to use direct git commands to clone from Azure DevOps instead of actions/checkout
      - name: Checkout test-data-shared from Azure DevOps
        shell: pwsh
        working-directory: ${{ github.workspace }}/..
        run: |
          $pat = "${{ secrets.AZURE_DEVOPS_PAT }}"
          $encodedPat = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(":$pat"))
          
          # Configure git to use the PAT
          git config --global http.https://dev.azure.com.extraheader "AUTHORIZATION: Basic $encodedPat"
          
          # Clone with LFS to parent directory
          git lfs install
          git clone --depth 1 https://dev.azure.com/microsoft/windows.ai.toolkit/_git/test-data-shared test-data-shared
          
          Write-Host "Clone completed successfully to ${{ github.workspace }}/../test-data-shared"

      - name: Checkout specific commit in test-data-shared
        shell: pwsh
        working-directory: ${{ github.workspace }}/../test-data-shared
        run: |
          Write-Host "Current directory: $(Get-Location)"
          git checkout 231f820fe285145b7ea4a449b112c1228ce66a41
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Git checkout failed."
            exit 1
          }
          Write-Host "`nDirectory contents:"
          Get-ChildItem -Recurse -Depth 2 | ForEach-Object { Write-Host "  $($_.FullName)" }


      - name: npm install (WinML)
        if: ${{ inputs.useWinML == true }}
        working-directory: sdk_v2/js
        run: npm install --winml

      - name: npm install (Standard)
        if: ${{ inputs.useWinML == false }}
        working-directory: sdk_v2/js
        run: npm install --nightly

      # Verify that installing new packages doesn't strip custom native binary folders
      - name: npm install openai (verify persistence)
        working-directory: sdk_v2/js
        run: npm install openai

      - name: Set package version
        working-directory: sdk_v2/js
        run: npm version ${{ env.ProjectVersion }} --no-git-tag-version --allow-same-version

      - name: Run tests
        working-directory: sdk_v2/js
        run: npm test

      - name: Build package
        working-directory: sdk_v2/js
        run: npm run build

      - name: Pack npm package
        working-directory: sdk_v2/js
        run: npm pack

      - name: Rename WinML artifact
        if: ${{ inputs.useWinML == true }}
        shell: pwsh
        working-directory: sdk_v2/js
        run: |
          $tgz = Get-ChildItem *.tgz | Select-Object -First 1
          if ($tgz) {
              $newName = $tgz.Name -replace '^foundry-local-sdk-', 'foundry-local-sdk-winml-'
              Rename-Item -Path $tgz.FullName -NewName $newName
              Write-Host "Renamed $($tgz.Name) to $newName"
          }

      - name: Upload npm packages
        uses: actions/upload-artifact@v4
        with:
          name: js-sdk-${{ inputs.platform }}
          path: sdk_v2/js/*.tgz
